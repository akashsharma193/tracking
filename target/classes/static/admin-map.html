<!DOCTYPE html>
<html>
  <head>
    <title>Live Map</title>
  </head>
  <body>
    <h2>Live Map</h2>
    <iframe id='map' width='100%' height='500'></iframe>
    <div id="latestPanel" style="margin:10px 0; padding:8px; border:1px solid #ccc; max-width:800px;">
      Loading latest visit...
    </div>
    <button id="resetBtn" type="button" style="margin-top:8px;">Reset Data</button>
    <script>
      // Load last visit into iframe
      fetch('/admin/data').then(r => r.json()).then(d => { if (d.length > 0) { let v = d[d.length - 1]; if (typeof v.latitude === 'number' && isFinite(v.latitude) && typeof v.longitude === 'number' && isFinite(v.longitude)) { document.getElementById('map').src = 'https://www.google.com/maps?q=' + v.latitude + ',' + v.longitude + '&z=15&output=embed'; } } });

      // Load latest details into panel
      function loadLatest(){
        fetch('/admin/data').then(r => r.json()).then(list => {
          if (list.length === 0) {
            document.getElementById('latestPanel').innerText = 'No visits yet';
            return;
          }
          const v = list[list.length - 1];
          const parts = [];
          if (v.shortCode) parts.push('Code: ' + v.shortCode);
          if (v.city) parts.push('City: ' + v.city);
          if (v.country) parts.push('Country: ' + v.country);
          if (typeof v.latitude === 'number' && typeof v.longitude === 'number') {
            parts.push('Lat: ' + v.latitude, 'Lon: ' + v.longitude);
          }
          document.getElementById('latestPanel').innerText = parts.join(' | ');
        });
      }
      loadLatest();

      // Reset data
      document.getElementById('resetBtn').addEventListener('click', function(){
        fetch('/admin/reset', {method:'POST'}).then(() => { loadLatest(); location.reload(); });
      });
    </script>
  </body>
</html>
